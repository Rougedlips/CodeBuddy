<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUDA矩阵乘法动画演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a3a7c, #3a4a8c);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #4fc3f7;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            font-size: 1.8rem;
            margin: 25px 0 15px;
            color: #81d4fa;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 8px;
        }
        
        h3 {
            font-size: 1.4rem;
            margin: 20px 0 10px;
            color: #b3e5fc;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #bbdefb;
        }
        
        .content {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .code-section {
            flex: 0 0 35%;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .animation-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .code-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #4fc3f7;
            max-height: 500px;
            overflow-y: auto;
        }
        
        pre {
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre;
            line-height: 1.5;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .code-line {
            padding: 2px 5px;
            transition: all 0.3s;
            min-height: 20px;
            border-left: 3px solid transparent;
            white-space: pre;
        }
        
        .highlight {
            background-color: rgba(79, 195, 247, 0.2);
            border-radius: 3px;
            border-left: 3px solid #4fc3f7;
            box-shadow: 0 0 8px rgba(79, 195, 247, 0.3);
        }
        
        .explanation {
            background: rgba(30, 30, 60, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #7e57c2;
            font-size: 0.9rem;
        }
        
        .animation-area {
            height: 600px;
            position: relative;
            background: rgba(10, 15, 30, 0.7);
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
            border: 2px solid #4fc3f7;
        }
        
        .host, .device {
            position: absolute;
            width: 45%;
            padding: 15px;
            background: rgba(30, 40, 70, 0.8);
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .host {
            left: 2%;
            top: 5%;
            height: 90%;
            border: 2px solid #7e57c2;
        }
        
        .device {
            right: 2%;
            top: 5%;
            height: 90%;
            border: 2px solid #4fc3f7;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #bbdefb;
            font-size: 1.2rem;
        }
        
        .matrix-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 85%;
            overflow-y: auto;
            padding: 5px;
        }
        
        .matrix {
            display: grid;
            gap: 5px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .matrix-cell {
            width: 40px;
            height: 40px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.5s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .matrix-a {
            background: #7e57c2;
            color: white;
        }
        
        .matrix-b {
            background: #4fc3f7;
            color: #1a237e;
        }
        
        .matrix-c {
            background: #66bb6a;
            color: white;
        }
        
        .active {
            box-shadow: 0 0 10px #ff9800;
            transform: scale(1.1);
            background: #ff9800 !important;
            color: #1a237e !important;
        }
        
        .computing {
            background: #ff9800 !important;
            color: #1a237e !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .thread-block {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #ff9800;
            color: #1a237e;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            font-size: 0.7rem;
            text-align: center;
            padding: 5px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 25px;
            background: #4fc3f7;
            color: #1a237e;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            background: #29b6f6;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #546e7a;
            cursor: not-allowed;
            transform: none;
        }
        
        .step-indicator {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2rem;
            color: #bbdefb;
            min-height: 40px;
        }
        
        .kernel-execution {
            position: absolute;
            width: 90%;
            height: 80px;
            bottom: 5%;
            left: 5%;
            background: rgba(255, 152, 0, 0.2);
            border-radius: 8px;
            border: 2px dashed #ff9800;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ff9800;
            font-size: 1.1rem;
            text-align: center;
            padding: 10px;
        }
        
        .threads-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            min-height: 80px;
        }
        
        .thread {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            background: #4fc3f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a237e;
            transition: all 0.5s;
            font-size: 0.9rem;
        }
        
        .thread.active {
            background: #ff9800;
            transform: scale(1.1);
        }
        
        .thread.result {
            background: #66bb6a;
            color: white;
        }
        
        .comparison {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .comparison-item {
            text-align: center;
            padding: 15px;
            background: rgba(30, 40, 70, 0.8);
            border-radius: 8px;
            flex: 1;
            margin: 0 10px;
        }
        
        .memory-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 85%;
            overflow-y: auto;
            padding: 5px;
        }
        
        .memory-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 60px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 5px 0;
        }
        
        .memory-cell {
            width: 80px;
            height: 50px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
            padding: 5px;
            font-size: 0.9rem;
            transition: all 0.5s ease;
        }
        
        .host-cell {
            background: #7e57c2;
            color: white;
        }
        
        .device-cell {
            background: #4fc3f7;
            color: #1a237e;
        }
        
        .result-cell {
            background: #66bb6a;
            color: white;
        }
        
        .transfer-arrow {
            position: absolute;
            width: 30px;
            height: 4px;
            background: #ff9800;
            z-index: 5;
        }
        
        .transfer-arrow::after {
            content: '';
            position: absolute;
            right: -10px;
            top: -8px;
            width: 0;
            height: 0;
            border-left: 10px solid #ff9800;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }
        
        .code-highlight-info {
            background: rgba(79, 195, 247, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #4fc3f7;
            font-size: 0.9rem;
        }
        
        .matrix-label {
            text-align: center;
            font-weight: bold;
            margin-bottom: 5px;
            color: #bbdefb;
        }
        
        .matrix-dimensions {
            font-size: 0.8rem;
            color: #90a4ae;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .computation-path {
            position: absolute;
            background: rgba(255, 152, 0, 0.3);
            border-radius: 3px;
            z-index: 1;
            transition: all 0.5s ease;
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
            
            .code-section {
                flex: 1;
            }
            
            .host, .device {
                width: 90%;
                position: relative;
                margin-bottom: 20px;
                height: 400px;
            }
            
            .animation-area {
                height: 900px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CUDA矩阵乘法动画演示</h1>
            <p class="subtitle">使用动画展示GPU并行矩阵乘法计算过程</p>
        </header>
        
        <div class="content">
            <div class="code-section">
                <h2>CUDA矩阵乘法代码</h2>
                <div class="code-container" id="code-container">
                    <pre id="code-content"></pre>
                </div>
                
                <div class="code-highlight-info" id="code-highlight-info">
                    当前高亮显示: <strong>核函数定义</strong>
                </div>
                
                <div class="explanation">
                    <h3>代码说明</h3>
                    <p>这段代码展示了CUDA矩阵乘法的完整流程：</p>
                    <ol>
                        <li>定义矩阵乘法的核函数</li>
                        <li>在主机上分配和初始化矩阵数据</li>
                        <li>在设备上分配内存空间</li>
                        <li>数据传输和核函数执行</li>
                        <li>结果验证和内存释放</li>
                    </ol>
                </div>
            </div>
            
            <div class="animation-section">
                <h2>矩阵乘法动画演示</h2>
                <div class="step-indicator" id="step-indicator">步骤 1: 核函数定义</div>
                
                <div class="animation-area">
                    <div class="host">
                        <div class="section-title">主机 (CPU) 内存</div>
                        <div class="matrix-container" id="host-container">
                            <div class="matrix-label">矩阵 A (3×3)</div>
                            <div class="matrix-dimensions">输入矩阵</div>
                            <div class="matrix" id="matrix-a" style="grid-template-columns: repeat(3, 1fr);"></div>
                            
                            <div class="matrix-label">矩阵 B (3×3)</div>
                            <div class="matrix-dimensions">输入矩阵</div>
                            <div class="matrix" id="matrix-b" style="grid-template-columns: repeat(3, 1fr);"></div>
                            
                            <div class="matrix-label">矩阵 C (3×3)</div>
                            <div class="matrix-dimensions">结果矩阵</div>
                            <div class="matrix" id="matrix-c" style="grid-template-columns: repeat(3, 1fr);"></div>
                        </div>
                    </div>
                    
                    <div class="device">
                        <div class="section-title">设备 (GPU) 内存</div>
                        <div class="matrix-container" id="device-container">
                            <div class="matrix-label">矩阵 d_A (3×3)</div>
                            <div class="matrix-dimensions">设备输入矩阵</div>
                            <div class="matrix" id="device-matrix-a" style="grid-template-columns: repeat(3, 1fr);"></div>
                            
                            <div class="matrix-label">矩阵 d_B (3×3)</div>
                            <div class="matrix-dimensions">设备输入矩阵</div>
                            <div class="matrix" id="device-matrix-b" style="grid-template-columns: repeat(3, 1fr);"></div>
                            
                            <div class="matrix-label">矩阵 d_C (3×3)</div>
                            <div class="matrix-dimensions">设备结果矩阵</div>
                            <div class="matrix" id="device-matrix-c" style="grid-template-columns: repeat(3, 1fr);"></div>
                        </div>
                        <div id="kernel-execution" class="kernel-execution" style="display: none;">
                            核函数执行中...
                        </div>
                    </div>
                    
                    <div id="computation-paths"></div>
                </div>
                
                <div class="threads-container" id="threads-container"></div>
                
                <div class="controls">
                    <button id="prev-btn" disabled>上一步</button>
                    <button id="next-btn">下一步</button>
                    <button id="reset-btn">重置</button>
                    <button id="auto-btn">自动播放</button>
                </div>
                
                <div class="explanation" id="step-explanation">
                    <h3>当前步骤说明</h3>
                    <p id="explanation-text">定义矩阵乘法的核函数，每个线程负责计算结果矩阵中的一个元素。</p>
                </div>
            </div>
        </div>
        
        <div class="comparison">
            <div class="comparison-item">
                <h3>CPU 顺序执行</h3>
                <p>三重循环，需要27次乘法和27次加法</p>
                <div class="code-container">
                    for(i=0; i<3; i++) {
                      for(j=0; j<3; j++) {
                        for(k=0; k<3; k++) {
                          C[i][j] += A[i][k] * B[k][j];
                        }
                      }
                    }
                </div>
            </div>
            
            <div class="comparison-item">
                <h3>GPU 并行执行</h3>
                <p>9个线程同时计算，每个线程负责一个元素</p>
                <div class="code-container">
                    matrixMultiply<<<3, 3>>>(d_A, d_B, d_C);
                </div>
            </div>
        </div>
    </div>

    <script>
        // 代码字符串 - 保持原始格式
        const codeString = `#include <stdio.h>
#include <cuda_runtime.h>

#define BLOCK_SIZE 3
#define MATRIX_SIZE 3

// 核函数定义 - 每个线程计算一个矩阵元素
__global__ void matrixMultiply(int* A, int* B, int* C) {
    int row = blockIdx.y * blockDim.y + threadIdx.y;
    int col = blockIdx.x * blockDim.x + threadIdx.x;
    
    if (row < MATRIX_SIZE && col < MATRIX_SIZE) {
        int sum = 0;
        for (int k = 0; k < MATRIX_SIZE; k++) {
            sum += A[row * MATRIX_SIZE + k] * B[k * MATRIX_SIZE + col];
        }
        C[row * MATRIX_SIZE + col] = sum;
    }
}

int main(void) {
    // 1. 主机内存分配
    int h_A[MATRIX_SIZE][MATRIX_SIZE];
    int h_B[MATRIX_SIZE][MATRIX_SIZE];
    int h_C[MATRIX_SIZE][MATRIX_SIZE];
    
    // 2. 设备内存分配
    int *d_A, *d_B, *d_C;
    cudaMalloc((void**)&d_A, MATRIX_SIZE * MATRIX_SIZE * sizeof(int));
    cudaMalloc((void**)&d_B, MATRIX_SIZE * MATRIX_SIZE * sizeof(int));
    cudaMalloc((void**)&d_C, MATRIX_SIZE * MATRIX_SIZE * sizeof(int));
    
    // 3. 初始化主机数据
    for (int i = 0; i < MATRIX_SIZE; i++) {
        for (int j = 0; j < MATRIX_SIZE; j++) {
            h_A[i][j] = i * MATRIX_SIZE + j + 1;
            h_B[i][j] = (i + 1) * (j + 1);
            h_C[i][j] = 0;
        }
    }
    
    // 4. 数据传输：主机 → 设备
    cudaMemcpy(d_A, h_A, MATRIX_SIZE * MATRIX_SIZE * sizeof(int), 
               cudaMemcpyHostToDevice);
    cudaMemcpy(d_B, h_B, MATRIX_SIZE * MATRIX_SIZE * sizeof(int), 
               cudaMemcpyHostToDevice);
    
    // 5. 定义线程块和网格大小
    dim3 threadsPerBlock(BLOCK_SIZE, BLOCK_SIZE);
    dim3 blocksPerGrid(1, 1);
    
    // 6. 启动核函数
    matrixMultiply<<<blocksPerGrid, threadsPerBlock>>>(d_A, d_B, d_C);
    
    // 7. 数据传输：设备 → 主机
    cudaMemcpy(h_C, d_C, MATRIX_SIZE * MATRIX_SIZE * sizeof(int), 
               cudaMemcpyDeviceToHost);
    
    // 8. 输出结果
    printf("Matrix multiplication on GPU \\n");
    printf("Matrix A:\\n");
    for (int i = 0; i < MATRIX_SIZE; i++) {
        for (int j = 0; j < MATRIX_SIZE; j++) {
            printf("%d ", h_A[i][j]);
        }
        printf("\\n");
    }
    
    printf("Matrix B:\\n");
    for (int i = 0; i < MATRIX_SIZE; i++) {
        for (int j = 0; j < MATRIX_SIZE; j++) {
            printf("%d ", h_B[i][j]);
        }
        printf("\\n");
    }
    
    printf("Result Matrix C:\\n");
    for (int i = 0; i < MATRIX_SIZE; i++) {
        for (int j = 0; j < MATRIX_SIZE; j++) {
            printf("%d ", h_C[i][j]);
        }
        printf("\\n");
    }
    
    // 9. 释放设备内存
    cudaFree(d_A);
    cudaFree(d_B);
    cudaFree(d_C);
    
    return 0;
}`;

        // 步骤数据和说明
        const steps = [
            {
                title: "步骤 1: 核函数定义",
                explanation: "定义矩阵乘法的核函数，每个线程负责计算结果矩阵中的一个元素。",
                codeLines: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18],
                codeHighlightText: "核函数定义",
                animation: "kernelDefinition"
            },
            {
                title: "步骤 2: 主机内存分配",
                explanation: "在主机上分配内存空间，用于存储输入矩阵 A、B 和结果矩阵 C。",
                codeLines: [22, 23, 24],
                codeHighlightText: "主机内存分配",
                animation: "hostAllocation"
            },
            {
                title: "步骤 3: 设备内存分配",
                explanation: "使用 cudaMalloc 在GPU上分配内存空间，用于存储设备端的矩阵数据。",
                codeLines: [27, 28, 29, 30, 31, 32],
                codeHighlightText: "设备内存分配",
                animation: "deviceAllocation"
            },
            {
                title: "步骤 4: 初始化主机数据",
                explanation: "初始化矩阵 A 和 B 的数据。矩阵 A 按行优先顺序填充，矩阵 B 按公式 (i+1)*(j+1) 填充。",
                codeLines: [35, 36, 37, 38, 39, 40, 41, 42, 43],
                codeHighlightText: "初始化主机数据",
                animation: "hostInitialization"
            },
            {
                title: "步骤 5: 数据传输 (主机 → 设备)",
                explanation: "使用 cudaMemcpy 将矩阵数据从主机内存传输到设备内存。",
                codeLines: [46, 47, 48, 49],
                codeHighlightText: "主机到设备数据传输",
                animation: "hostToDeviceTransfer"
            },
            {
                title: "步骤 6: 定义线程配置",
                explanation: "定义线程块大小和网格配置，使用 3×3 的线程块。",
                codeLines: [52, 53],
                codeHighlightText: "定义线程配置",
                animation: "threadConfiguration"
            },
            {
                title: "步骤 7: 启动核函数",
                explanation: "启动 matrixMultiply 核函数，使用9个线程并行执行矩阵乘法。",
                codeLines: [56],
                codeHighlightText: "启动核函数",
                animation: "kernelLaunch"
            },
            {
                title: "步骤 8: 核函数执行",
                explanation: "每个线程计算矩阵 C 的一个元素：C[i][j] = Σ(A[i][k] * B[k][j])。",
                codeLines: [11, 12, 13, 14, 15, 16, 17],
                codeHighlightText: "核函数执行",
                animation: "kernelExecution"
            },
            {
                title: "步骤 9: 数据传输 (设备 → 主机)",
                explanation: "将计算结果从设备内存传输回主机内存。",
                codeLines: [59, 60, 61],
                codeHighlightText: "设备到主机数据传输",
                animation: "deviceToHostTransfer"
            },
            {
                title: "步骤 10: 释放设备内存",
                explanation: "使用 cudaFree 释放GPU上分配的内存，避免内存泄漏。",
                codeLines: [85, 86, 87],
                codeHighlightText: "释放设备内存",
                animation: "deviceFree"
            }
        ];

        // 初始化矩阵数据
        const MATRIX_SIZE = 3;
        const h_A = [
            [1, 2, 3],
            [4, 5, 6],
            [7, 8, 9]
        ];
        const h_B = [
            [1, 2, 3],
            [2, 4, 6],
            [3, 6, 9]
        ];
        const h_C = [
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0]
        ];
        
        let currentStep = 0;
        let autoPlayInterval = null;
        let isAnimating = false;
        
        // DOM 元素
        const stepIndicator = document.getElementById('step-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-btn');
        const autoBtn = document.getElementById('auto-btn');