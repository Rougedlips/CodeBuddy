<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUDA向量加法动画演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a3a7c, #3a4a8c);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #4fc3f7;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            font-size: 1.8rem;
            margin: 25px 0 15px;
            color: #81d4fa;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 8px;
        }
        
        h3 {
            font-size: 1.4rem;
            margin: 20px 0 10px;
            color: #b3e5fc;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #bbdefb;
        }
        
        .content {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .code-section {
            flex: 0 0 35%;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .animation-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .code-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #4fc3f7;
            max-height: 500px;
            overflow-y: auto;
        }
        
        pre {
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre;
            line-height: 1.5;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .code-line {
            padding: 2px 5px;
            transition: all 0.3s;
            min-height: 20px;
            border-left: 3px solid transparent;
            white-space: pre;
        }
        
        .highlight {
            background-color: rgba(79, 195, 247, 0.2);
            border-radius: 3px;
            border-left: 3px solid #4fc3f7;
            box-shadow: 0 0 8px rgba(79, 195, 247, 0.3);
        }
        
        .explanation {
            background: rgba(30, 30, 60, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #7e57c2;
            font-size: 0.9rem;
        }
        
        .animation-area {
            height: 500px;
            position: relative;
            background: rgba(10, 15, 30, 0.7);
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
            border: 2px solid #4fc3f7;
        }
        
        .host, .device {
            position: absolute;
            width: 45%;
            padding: 15px;
            background: rgba(30, 40, 70, 0.8);
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .host {
            left: 2%;
            top: 5%;
            height: 90%;
            border: 2px solid #7e57c2;
        }
        
        .device {
            right: 2%;
            top: 5%;
            height: 90%;
            border: 2px solid #4fc3f7;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #bbdefb;
            font-size: 1.2rem;
        }
        
        .memory-block {
            position: absolute;
            width: 90px;
            height: 50px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.8s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            text-align: center;
            padding: 5px;
        }
        
        .host-memory {
            background: #7e57c2;
            color: white;
        }
        
        .device-memory {
            background: #4fc3f7;
            color: #1a237e;
        }
        
        .data-transfer {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff9800;
            transition: all 1s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #1a237e;
            font-weight: bold;
        }
        
        .thread-block {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #ff9800;
            color: #1a237e;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 25px;
            background: #4fc3f7;
            color: #1a237e;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            background: #29b6f6;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #546e7a;
            cursor: not-allowed;
            transform: none;
        }
        
        .step-indicator {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2rem;
            color: #bbdefb;
            min-height: 40px;
        }
        
        .kernel-execution {
            position: absolute;
            width: 90%;
            height: 100px;
            bottom: 5%;
            left: 5%;
            background: rgba(255, 152, 0, 0.2);
            border-radius: 8px;
            border: 2px dashed #ff9800;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ff9800;
            font-size: 1.1rem;
            text-align: center;
            padding: 10px;
        }
        
        .threads-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            min-height: 80px;
        }
        
        .thread {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            background: #4fc3f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a237e;
            transition: all 0.5s;
            font-size: 0.9rem;
        }
        
        .active {
            background: #ff9800;
            transform: scale(1.1);
        }
        
        .result {
            background: #66bb6a;
            color: white;
        }
        
        .comparison {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .comparison-item {
            text-align: center;
            padding: 15px;
            background: rgba(30, 40, 70, 0.8);
            border-radius: 8px;
            flex: 1;
            margin: 0 10px;
        }
        
        .memory-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 85%;
            overflow-y: auto;
            padding: 5px;
        }
        
        .memory-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 60px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 5px 0;
        }
        
        .memory-cell {
            width: 80px;
            height: 50px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
            padding: 5px;
            font-size: 0.9rem;
            transition: all 0.5s ease;
        }
        
        .host-cell {
            background: #7e57c2;
            color: white;
        }
        
        .device-cell {
            background: #4fc3f7;
            color: #1a237e;
        }
        
        .result-cell {
            background: #66bb6a;
            color: white;
        }
        
        .transfer-arrow {
            position: absolute;
            width: 30px;
            height: 4px;
            background: #ff9800;
            z-index: 5;
        }
        
        .transfer-arrow::after {
            content: '';
            position: absolute;
            right: -10px;
            top: -8px;
            width: 0;
            height: 0;
            border-left: 10px solid #ff9800;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }
        
        .code-highlight-info {
            background: rgba(79, 195, 247, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #4fc3f7;
            font-size: 0.9rem;
        }
        
        @media (max-width: 1000px) {
            .content {
                flex-direction: column;
            }
            
            .code-section {
                flex: 1;
            }
            
            .host, .device {
                width: 90%;
                position: relative;
                margin-bottom: 20px;
                height: 300px;
            }
            
            .animation-area {
                height: 700px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CUDA向量加法动画演示</h1>
            <p class="subtitle">使用动画展示GPU并行计算过程</p>
        </header>
        
        <div class="content">
            <div class="code-section">
                <h2>CUDA向量加法代码</h2>
                <div class="code-container" id="code-container">
                    <pre id="code-content"></pre>
                </div>
                
                <div class="code-highlight-info" id="code-highlight-info">
                    当前高亮显示: <strong>主机内存分配</strong>
                </div>
                
                <div class="explanation">
                    <h3>代码说明</h3>
                    <p>这段代码展示了CUDA编程的基本流程：</p>
                    <ol>
                        <li>在主机(CPU)上分配和初始化数据</li>
                        <li>在设备(GPU)上分配内存</li>
                        <li>将数据从主机传输到设备</li>
                        <li>启动核函数在GPU上并行执行计算</li>
                        <li>将结果从设备传输回主机</li>
                        <li>输出结果并释放设备内存</li>
                    </ol>
                </div>
            </div>
            
            <div class="animation-section">
                <h2>执行过程动画演示</h2>
                <div class="step-indicator" id="step-indicator">步骤 1: 主机内存分配</div>
                
                <div class="animation-area">
                    <div class="host">
                        <div class="section-title">主机 (CPU) 内存</div>
                        <div class="memory-container" id="host-container"></div>
                    </div>
                    
                    <div class="device">
                        <div class="section-title">设备 (GPU) 内存</div>
                        <div class="memory-container" id="device-container"></div>
                        <div id="kernel-execution" class="kernel-execution" style="display: none;">
                            核函数执行中...
                        </div>
                    </div>
                    
                    <div id="data-transfers"></div>
                    <div id="transfer-arrows"></div>
                </div>
                
                <div class="threads-container" id="threads-container"></div>
                
                <div class="controls">
                    <button id="prev-btn" disabled>上一步</button>
                    <button id="next-btn">下一步</button>
                    <button id="reset-btn">重置</button>
                    <button id="auto-btn">自动播放</button>
                </div>
                
                <div class="explanation" id="step-explanation">
                    <h3>当前步骤说明</h3>
                    <p id="explanation-text">在主机上分配内存空间，用于存储数组 h_a, h_b 和 h_c。</p>
                </div>
            </div>
        </div>
        
        <div class="comparison">
            <div class="comparison-item">
                <h3>CPU 顺序执行</h3>
                <p>每个元素依次计算，需要5个步骤</p>
                <div class="code-container">
                    for(i=0; i<5; i++) {
                      h_c[i] = h_a[i] + h_b[i];
                    }
                </div>
            </div>
            
            <div class="comparison-item">
                <h3>GPU 并行执行</h3>
                <p>所有元素同时计算，只需1个步骤</p>
                <div class="code-container">
                    gpuAdd<<<5, 1>>>(d_a, d_b, d_c);
                </div>
            </div>
        </div>
    </div>

    <script>
        // 代码字符串 - 保持原始格式
        const codeString = `#include <stdio.h>
#include <cuda_runtime.h>

#define N 5

// 核函数定义 - 在GPU上执行
__global__ void gpuAdd(int* d_a, int* d_b, int* d_c) {
    int tid = blockIdx.x;
    if (tid < N)
        d_c[tid] = d_a[tid] + d_b[tid];
}

int main(void) {
    // 1. 主机内存分配
    int h_a[N], h_b[N], h_c[N];
    
    // 2. 设备内存分配
    int *d_a, *d_b, *d_c;
    cudaMalloc((void**)&d_a, N * sizeof(int));
    cudaMalloc((void**)&d_b, N * sizeof(int));
    cudaMalloc((void**)&d_c, N * sizeof(int));
    
    // 3. 初始化主机数据
    for (int i = 0; i < N; i++) {
        h_a[i] = 2 * i * i;
        h_b[i] = i;
    }
    
    // 4. 数据传输：主机 → 设备
    cudaMemcpy(d_a, h_a, N * sizeof(int), cudaMemcpyHostToDevice);
    cudaMemcpy(d_b, h_b, N * sizeof(int), cudaMemcpyHostToDevice);
    
    // 5. 启动核函数
    gpuAdd<<<N, 1>>>(d_a, d_b, d_c);
    
    // 6. 数据传输：设备 → 主机
    cudaMemcpy(h_c, d_c, N * sizeof(int), cudaMemcpyDeviceToHost);
    
    // 7. 输出结果
    printf("Vector addition on GPU \\n");
    for (int i = 0; i < N; i++) {
        printf("The sum of %d element is %d + %d = %d\\n", 
               i, h_a[i], h_b[i], h_c[i]);
    }
    
    // 8. 释放设备内存
    cudaFree(d_a);
    cudaFree(d_b);
    cudaFree(d_c);
    
    return 0;
}`;

        // 步骤数据和说明 - 重新映射行号
        const steps = [
            {
                title: "步骤 1: 主机内存分配",
                explanation: "在主机上分配内存空间，用于存储数组 h_a, h_b 和 h_c。",
                codeLines: [15, 16],
                codeHighlightText: "主机内存分配",
                animation: "hostAllocation"
            },
            {
                title: "步骤 2: 设备内存分配",
                explanation: "使用 cudaMalloc 在GPU上分配内存空间，用于存储输入和输出数据。",
                codeLines: [19, 20, 21, 22, 23, 24],
                codeHighlightText: "设备内存分配",
                animation: "deviceAllocation"
            },
            {
                title: "步骤 3: 初始化主机数据",
                explanation: "初始化主机上的数组 h_a 和 h_b。h_a 存储值 2*i²，h_b 存储值 i。",
                codeLines: [27, 28, 29, 30, 31, 32],
                codeHighlightText: "初始化主机数据",
                animation: "hostInitialization"
            },
            {
                title: "步骤 4: 数据传输 (主机 → 设备)",
                explanation: "使用 cudaMemcpy 将数据从主机内存传输到设备内存。",
                codeLines: [35, 36],
                codeHighlightText: "主机到设备数据传输",
                animation: "hostToDeviceTransfer"
            },
            {
                title: "步骤 5: 启动核函数",
                explanation: "启动 gpuAdd 核函数，使用5个线程块，每个块1个线程并行执行向量加法。",
                codeLines: [39],
                codeHighlightText: "启动核函数",
                animation: "kernelLaunch"
            },
            {
                title: "步骤 6: 核函数执行",
                explanation: "每个线程块计算一个数组元素的和：d_c[i] = d_a[i] + d_b[i]。",
                codeLines: [8, 9, 10],
                codeHighlightText: "核函数执行",
                animation: "kernelExecution"
            },
            {
                title: "步骤 7: 数据传输 (设备 → 主机)",
                explanation: "将计算结果从设备内存传输回主机内存。",
                codeLines: [42],
                codeHighlightText: "设备到主机数据传输",
                animation: "deviceToHostTransfer"
            },
            {
                title: "步骤 8: 释放设备内存",
                explanation: "使用 cudaFree 释放GPU上分配的内存，避免内存泄漏。",
                codeLines: [48, 49, 50],
                codeHighlightText: "释放设备内存",
                animation: "deviceFree"
            }
        ];

        // 初始化数据
        const N = 5;
        const h_a = [0, 2, 8, 18, 32];
        const h_b = [0, 1, 2, 3, 4];
        const h_c = [0, 0, 0, 0, 0];
        
        let currentStep = 0;
        let autoPlayInterval = null;
        let isAnimating = false;
        
        // DOM 元素
        const stepIndicator = document.getElementById('step-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-btn');
        const autoBtn = document.getElementById('auto-btn');